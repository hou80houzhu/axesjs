/*!
 * @packet opensite.mobi.datepicker; 
 * @require opensite.mobi.form;
 * @template opensite.mobi.template.formtemplate;
 */Module({name:"datep",extend:"@form.fieldgroup",className:"datep",layout:module.getTemplate("@formtemplate","datep"),option:{withTime:!0},onbeforeinit:function(){this.option.value&&""!==this.option.value||(this.option.value=$.formatDate(),this.value=this.option.value),this.option.withTime?this.value=this.option.value:(this.value=this.value.substring(0,10),this.option.value=this.value)},find_btn:function(t){t.button(function(t,e){e.addChild({type:"@.datepicker",option:e.option,parameters:e.value})},this)},event_dateselected:function(){var t=this.getFirstChild().getValue();this.value=t,this.finders.get("btn").html(t),this.getFirstChild().remove()},getValue:function(){return this.finders.get("btn").html()},setValue:function(t){this.option.withTime?-1!==t.indexOf(":")?this.value=t:this.value=t+" 00:00:00":-1!==t.indexOf(":")?this.value=t.substring(0,10):this.value=t,this.option.value=this.value,this.finders.get("btn").html(this.value)}}),Module({name:"datepicker",extend:"@form.fieldgroup",className:"dpicker",layout:module.getTemplate("@formtemplate","dpicker"),option:{},init:function(){this.addChild({type:"@.datepanel",option:this.option,container:this.dom.children(1)}).done(function(t){t.setDateTime(this.parameters)})},find_bg:function(t){var e=this;t.bind("touchstart",function(t){e.remove()})},getValue:function(){return this.getFirstChild().getDate()},setValue:function(t){this.value=t}}),Module({name:"datepanel",extend:"view",className:"datepanel",template:module.getTemplate("@formtemplate","datepanel"),option:{year:(new Date).getFullYear(),month:(new Date).getMonth(),day:1,withTime:!0,format:"yyyy-MM-dd hh:mm:ss"},init:function(){this.Year=this.option.year,this.Month=this.option.month,this.Dateis=0,this.Hour=0,this.Minite=0,this.Second=0,this.render(this.option).done(function(){this.refresh()})},find_prev:function(t){t.button(function(t,e){e.prvemonth()},this)},find_next:function(t){t.button(function(t,e){e.nextmonth()},this)},find_current:function(t){this._header=t,t.button(function(t,e){e.yearbody.show(),e.currentyears()},this)},find_day:function(t){this._day=t,t.hasClass("disabled")||t.button(function(t,e){e.Dateis=parseInt($(this).children(0).html()),e.dom.find(".selected").removeClass("selected"),$(this).children(0).addClass("selected")},this)},find_selectdate:function(t){t.button(function(t,e){e.dispatchEvent("dateselected",{year:e.Year,month:e.Month,date:e.Dateis})},this)},find_databody:function(t){this.dbody=t},find_yearbody:function(t){this.yearbody=t,t.hide()},find_yleft:function(t){t.button(function(t,e){e.prevyears()},this)},find_yright:function(t){t.button(function(t,e){e.nextyears()},this)},find_year:function(t){t.button(function(t,e){e.Year=parseInt($(this).html()),e.yearbody.hide(),e.monthbody.show()},this)},find_monthbody:function(t){this.monthbody=t,t.hide()},find_month:function(t){t.button(function(t,e){e.Month=parseInt($(this).html()),e.monthbody.hide(),e.refresh()},this)},find_shour:function(t){t.button(function(t,e){e.finders.get("phour").show()},this)},find_stime:function(t){t.button(function(t,e){e.finders.get("psecond").data("time","time").show()},this)},find_ssecond:function(t){t.button(function(t,e){e.finders.get("psecond").data("time","second").show()},this)},find_second:function(t){t.button(function(t,e){var i=e.finders.get("psecond");"time"===i.data("time")?(e.Minite=parseInt($(this).html()),e.finders.get("stime").children(0).html(e.Minite)):(e.Second=parseInt($(this).html()),e.finders.get("ssecond").children(0).html(e.Second)),i.hide()},this)},find_hour:function(t){t.button(function(t,e){e.Hour=parseInt($(this).html()),console.log(e.Hour),e.finders.get("shour").children(0).html(e.Hour),e.finders.get("phour").hide()},this)},setDate:function(t,e){this.Year=t,this.Month=e,this.refresh()},currentyears:function(){for(var t=[],e=(new Date).getFullYear(),i=13;i>=0;i--)t.push(e-i);this.yearbody.html($.template(module.getTemplate("@formtemplate","datepanelyear")).render(t))},prevyears:function(){for(var t=[],e=parseInt(this.yearbody.children(1).html()),i=13;i>=0;i--)t.push(e-i);this.yearbody.html($.template(module.getTemplate("@formtemplate","datepanelyear")).render(t))},nextyears:function(){for(var t=[],e=parseInt(this.yearbody.children(14).html()),i=0;14>i;i++)t.push(e+i);this.yearbody.html($.template(module.getTemplate("@formtemplate","datepanelyear")).render(t))},prvemonth:function(){var t=this.Month-1;1>t&&(t=12,this.Year--),this.Month=t,this.refresh()},nextmonth:function(){var t=this.Month+1;t>12&&(t=1,this.Year++),this.Month=t,this.refresh()},getMonthDays:function(t,e){var i=[31,t%4===0?29:28,31,30,31,30,31,31,30,31,30,31];return i[e]},getDaysOfMonth:function(t,e){var i=t,n=e-2;-1===n&&(n=11,i=t-1);var s=new Date(t+"/"+e+"/1").getDay();0===s?s=6:s--;for(var h=this.getMonthDays(i,n),o=this.getMonthDays(t,e-1),a=[],r=0;42>r;r++)s>r&&o>r?a.push(h-s+r+1):r>=s&&o+s>r?a.push(r-s+1):r>=o&&(0===s?a.push(r-o-s):a.push(r-o-s+1));return a},getDaysByMonth:function(t,e){for(var i=(new Date).getFullYear(),n=(new Date).getMonth()+1,s=(new Date).getDate(),h=this.getDaysOfMonth(t,e),o=[],a=0,r=0;r<h.length;r++){var d=!1,l=!1;0===a?(i===t&&n===e-1&&h[r]===s&&(d=!0),t===this._selectedYear&&e-1===this._selectedMonth&&h[r]===this._selectedDay&&(l=!0)):1===a?(i===t&&n===e&&h[r]===s&&(d=!0),t===this._selectedYear&&e===this._selectedMonth&&h[r]===this._selectedDay&&(l=!0)):(i===t&&n===e+1&&h[r]===s&&(d=!0),t===this._selectedYear&&e+1===this._selectedMonth&&h[r]===this._selectedDay&&(l=!0)),1===h[r]?0===a?(a=1,o.push({current:d,disabled:!1,selected:l,value:h[r]})):1===a&&(a=2,o.push({current:d,selected:l,disabled:!0,value:h[r]})):0===a?o.push({current:d,selected:l,disabled:!0,value:h[r]}):2===a?o.push({current:d,selected:l,disabled:!0,value:h[r]}):o.push({current:d,selected:l,disabled:!1,value:h[r]})}return o},refresh:function(){this._header.html(this.Year+"-"+(0===this.Month?1:this.Month));var t=this.getDaysByMonth(this.Year,0===this.Month?1:this.Month);this.option.withTime&&(this.finders.get("stime").children(0).html(this.Minite),this.finders.get("shour").children(0).html(this.Hour),this.finders.get("ssecond").children(0).html(this.Second)),this.dbody.html($.template(module.getTemplate("@formtemplate","datepanelbody")).render(t))},getDate:function(){return this.formate()},setDateTime:function(t){if(t&&""!==t){-1===t.indexOf(":")&&(t+=" 00:00:00");var e=t.split(" ");t=e[0].split("-").join("/")+" "+e[1];var i=new Date(t);this.Year=i.getFullYear(),this.Month=i.getMonth()+1,this.Dateis=i.getDate(),this.Second=i.getSeconds(),this.Minite=i.getMinutes(),this.Hour=i.getHours(),this._selectedYear=this.Year,this._selectedMonth=this.Month,this._selectedDay=this.Dateis,this.refresh()}},formate:function(t){var e=this.option.format;this.option.withTime||(e="yyyy-MM-dd");var i=this.Hour,n=this.Minite,s=this.Second,h=this.Month,o=this.Dateis,a=this.Year;return e=e.replace("yyyy",a).replace("MM",h.toString().length<=1?"0"+h:h).replace("dd",o.toString().length<=1?"0"+o:o).replace("hh",i.toString().length<=1?"0"+i:i).replace("mm",n.toString().length<=1?"0"+n:n).replace("ss",s.toString().length<=1?"0"+s:s)}});