/*!
 * @packet opensite.mobi.gallery; 
 * @require opensite.mobi.util.file;
 * @template opensite.mobi.template.gallery:temp;
 * @css opensite.mobi.style.gallery;
 */Module({name:"singlepicwrapper",extend:"viewgroup",className:"singlepicwrapper",option:{thumb:"",pic:""},init:function(){this.dom.append("<div class='singlepicwrapper-thumb'><img src='"+this.option.thumb+"'></div>"),this.dom.append("<div class='singlepicwrapper-loading'><i class='fa fa-repeat fa-spin'></i> loading...</div>");var t=this;$.loader().image(this.option.pic,function(){t.addChild({type:"@.singlepic",option:{pic:t.option.pic},container:t.dom}),t.dom.children(0).remove(),t.dom.children(0).remove()},function(){t.remove(),$.toast("图片加载出错")})}}),Module({name:"singlepic",extend:"view",className:"singlepic",option:{pic:basePath+"packet/mobi/style/images/test.jpg"},init:function(){this.isfit=!1;var t=document.createElement("canvas");t.width=this.dom.width(),t.height=this.dom.height(),this.width=this.dom.width(),this.height=this.dom.height(),this.ctx=t.getContext("2d"),this.dom.append(t),this.loadPic().scope(this).done(function(t){this.image=t,this.drawPicDefault(),this.drawToolbar()});var i=this,h=0,e=!1,o=!1,a=!1,s=(new Date).getTime(),d=0,n=0,g=0;this.dom.bind("touchstart",function(t){2===t.touches.length?(e=!0,o=!1,a=!1,h=Math.sqrt(Math.pow(t.touches[0].pageX-t.touches[1].pageX,2)+Math.pow(t.touches[0].pageY-t.touches[1].pageY,2)),d=0):1===t.touches.length&&(o=!0,e=!1,a=!0,s=(new Date).getTime(),n=t.touches[0].pageX-i.__x,g=t.touches[0].pageY-i.__y),i.render(),t.stopPropagation(),t.preventDefault()}).bind("touchmove",function(t){if(a=!1,2===t.touches.length&&e){var s=Math.sqrt(Math.pow(t.touches[0].pageX-t.touches[1].pageX,2)+Math.pow(t.touches[0].pageY-t.touches[1].pageY,2))-h,d=i.__width+s/5,_=i._oheight/i._owidth*d,p=i.__x+i.__width/2-i.width/2,c=i.__y+i.__height/2-i.height/2,r=i.__x-(d-i.__width)/2+p*(d-i.__width)/d,w=i.__y-(_-i.__height)/2+c*(_-i.__height)/_;i.__x=r,i.__y=w,i.__width=d,i.__height=_}else if(1===t.touches.length&&o){if(i.__width>i.width){var l=t.touches[0].pageX-n;l>0&&(l=0),l<i.width-i.__width&&(l=i.width-i.__width),i.__x=l}if(i.__height>i.height){var u=t.touches[0].pageY-g;u>0&&(u=0),u<i.height-i.__height&&(u=i.height-i.__height),i.__y=u}}i.render(),t.stopPropagation(),t.preventDefault()}).bind("touchend",function(t){o=!1,e=!1;var h=i.__x,n=i.__y,g=i.__width,_=i.__height;if(i.__width<i.width||i.__height<i.height?i.__width<i.width&&i.__height>i.height?(h=(i.width-i.__width)/2,i.__y>0&&(n=0),i.__y<i.height-i.__height&&(n=i.height-i.__height)):i.__width>i.width&&i.__height<i.height?(n=(i.height-i.__height)/2,i.__x>0&&(h=0),i.__x<i.width-i.__width&&(h=i.width-i.__width)):(_=i.height,g=this._owidth/this._oheight*i.height,g<=i.width?(_=i._oheight/i._owidth*g,_>i.height&&(_=i.height,g=i._owidth/i._oheight*_)):(g=i.width,_=i._oheight/i._owidth*g,_>i.height&&(_=i.height,g=i._owidth/i._oheight*_)),h=(i.width-g)/2,n=(i.height-_)/2):(i.__y>0&&(n=0),i.__x>0&&(h=0)),i.__x=h,i.__y=n,i.__width=g,i.__height=_,i.render(),1===t.changedTouches.length){var p=(new Date).getTime()-s;if(a&&90>p){d++;var c=setTimeout(function(){d>=2&&i.dispatchEvent("doubleclick"),d=0,clearTimeout(c)},180)}}a=!1,t.stopPropagation(),t.preventDefault()})},find_back:function(t){t.button(function(t,i){i.parentView.remove()},this)},find_download:function(t){t.button(function(t,i){var h=$("iframe");0===h.length?$("<iframe src='"+i.option.pic+"' style='position:absolute;left:-99999px;top:-999999'></iframe>").appendTo("body"):h.attr("src",i.option.pic)},this)},drawToolbar:function(){var t="<div class='singlepic-toolbar'>";t+="<div class='singlepic-toolbar-btn' data-find='back'><i class='fa fa-arrow-left'></i></div>",t+="<div class='singlepic-toolbar-btne'><div class='singlepic-toolbar-btn' data-find='download'><i class='fa fa-download'></i></div></div>",t+="</div>",this.dom.append(t)},loadPic:function(){var t=$.promise(),i=this;return $.loader().image(this.option.pic,function(){i._owidth=this.width,i._oheight=this.height,t.resolve(this)}),t},drawPicDefault:function(){this.isfit=!0;var t,i,h,e,o=this.width,a=this.height;h=this.image.width/this.image.height*a,o>=h?(e=a,t=(o-h)/2,i=0):(e=this.image.height/this.image.width*o,a>=e?(h=o,t=0,i=(a-e)/2):(h=this.image.width,e=this.image.height,t=(o-this.image.width)/2,i=(a-this.image.height)/2)),this.__x=t,this.__y=i,this.__width=h,this.__height=e,this.render()},render:function(){this.ctx.clearRect(0,0,this.width,this.height),this.ctx.drawImage(this.image,this.__x,this.__y,this.__width,this.__height)},drawPicOriginal:function(){this.isfit=!1;var t,i,h,e;h=this.image.width,e=this.image.height,t=h>this.width?(this.width-h)/2:-(h-this.width)/2,i=i>this.height?(this.height-e)/2:-(e-this.height)/2,this.__x=t,this.__y=i,this.__width=h,this.__height=e,this.render()},event_doubleclick:function(){this.isfit?this.drawPicOriginal():this.drawPicDefault()}}),Module({name:"photocutter",extend:"view",className:"photocutter",option:{width:300,height:300,name:"file",imagefile:null},init:function(){this.isfit=!1;var t=document.createElement("canvas");t.width=this.dom.width(),t.height=this.dom.height(),this.width=this.dom.width(),this.height=this.dom.height(),this.ctx=t.getContext("2d"),this.dom.append(t),this.drawMask(),this.loadPic().scope(this).done(function(t){this.image=t,this.drawToolbar(),this.drawPicDefault()});var i=this,h=0,e=!1,o=!1,a=!1,s=(new Date).getTime(),d=0,n=0;this.dom.bind("touchstart",function(t){2===t.touches.length?(e=!0,o=!1,a=!1,h=Math.sqrt(Math.pow(t.touches[0].pageX-t.touches[1].pageX,2)+Math.pow(t.touches[0].pageY-t.touches[1].pageY,2))):1===t.touches.length&&(o=!0,e=!1,a=!0,s=(new Date).getTime(),d=t.touches[0].pageX-i.__x,n=t.touches[0].pageY-i.__y),i.render(),t.stopPropagation(),t.preventDefault()}).bind("touchmove",function(t){if(a=!1,2===t.touches.length&&e){var s=Math.sqrt(Math.pow(t.touches[0].pageX-t.touches[1].pageX,2)+Math.pow(t.touches[0].pageY-t.touches[1].pageY,2))-h,g=i.__width+s/5,_=i._oheight/i._owidth*g,p=i.__x+i.__width/2-i.width/2,c=i.__y+i.__height/2-i.height/2,r=i.__x-(g-i.__width)/2+p*(g-i.__width)/g,w=i.__y-(_-i.__height)/2+c*(_-i.__height)/_;i.__x=r,i.__y=w,i.__width=g,i.__height=_}else if(1===t.touches.length&&o){if(i.__width>i.option.width){var l=t.touches[0].pageX-d;l>(i.width-i.option.width)/2&&(l=(i.width-i.option.width)/2),l<i.width-i.__width-(i.width-i.option.width)/2&&(l=i.width-i.__width-(i.width-i.option.width)/2),i.__x=l}if(i.__height>i.option.height){var u=t.touches[0].pageY-n;u>(i.height-i.option.height)/2&&(u=(i.height-i.option.height)/2),u<i.height-i.__height-(i.height-i.option.height)/2&&(u=i.height-i.__height-(i.height-i.option.height)/2),i.__y=u}}i.render(),t.stopPropagation(),t.preventDefault()}).bind("touchend",function(t){o=!1,e=!1;var h=i.__x,s=i.__y,d=i.__width,n=i.__height;(i.__width<i.option.width||i.__height<i.option.height)&&(d<i.option.width&&(d=i.option.width,n=i.image.height/i.image.width*d,n<i.option.height&&(n=i.option.height,d=i.image.width/i.image.height*n)),n<i.option.height&&(n=i.option.height,d=i.image.width/i.image.height*n,d<i.option.width&&(d=i.option.width,n=i.image.height/i.image.width*d)),h=(i.width-d)/2,s=(i.height-n)/2),i.__x=h,i.__y=s,i.__width=d,i.__height=n,i.render(),a=!1,t.stopPropagation(),t.preventDefault()})},find_back:function(t){t.button(function(t,i){i.remove()},this)},find_check:function(t){t.button(function(t,i){i.upload()},this)},loadPic:function(){var t=$.promise(),i=this,h=new FileReader;return h.onload=function(h){$.loader().image(h.target.result,function(){i._owidth=this.width,i._oheight=this.height,t.resolve(this)})},h.readAsDataURL(this.option.imagefile),t},drawPicDefault:function(){this.isfit=!0;var t,i,h,e,o=this.width,a=this.height;h=this.image.width/this.image.height*a,o>=h?(e=a,t=(o-h)/2,i=0):(e=this.image.height/this.image.width*o,a>=e?(h=o,t=0,i=(a-e)/2):(h=this.image.width,e=this.image.height,t=(o-this.image.width)/2,i=(a-this.image.height)/2)),h<this.option.width&&(h=this.option.width,e=this.image.height/this.image.width*h,e<this.option.height&&(e=this.option.height,h=this.image.width/this.image.height*e)),e<this.option.height&&(e=this.option.height,h=this.image.width/this.image.height*e,h<this.option.width&&(h=this.option.width,e=this.image.height/this.image.width*h)),t=(o-h)/2,i=(a-e)/2,this.__x=t,this.__y=i,this.__width=h,this.__height=e,this.render()},render:function(){this.ctx.clearRect(0,0,this.width,this.height),this.ctx.drawImage(this.image,this.__x,this.__y,this.__width,this.__height)},drawMask:function(){var t=(this.width-this.option.width)/2,i=(this.height-this.option.height)/2,h="<div class='photocutter-mask'>";h+="<div class='phototcutter-mask-bg' style='left:0;top:0;width:"+t+"px;bottom:0'></div>",h+="<div class='phototcutter-mask-bg' style='left:"+t+"px;top:0;right:"+t+"px;height:"+i+"px'></div>",h+="<div class='phototcutter-mask-bg' style='right:0;top:0;bottom:0;width:"+t+"px'></div>",h+="<div class='phototcutter-mask-bg' style='left:"+t+"px;bottom:0;right:"+t+"px;height:"+i+"px'></div>",h+="<div class='phototcutter-mask-squrt' style='left:"+t+"px;top:"+i+"px;right:"+t+"px;bottom:"+i+"px'></div>",h+="</div>",$(h).appendTo(this.dom)},drawToolbar:function(){var t="<div class='photocutter-toolbar'>";t+="<div class='photocutter-toolbar-btn' data-find='back'><i class='fa fa-arrow-left'></i></div>",t+="<div class='photocutter-toolbar-btne'><div class='photocutter-toolbar-btn' data-find='check'><i class='fa fa-check'></i></div></div>",t+="</div>",this.dom.append(t)},getImageDate:function(t,i,h,e){var o=t||0,a=i||0,s=h||this.width,d=e||this.height,n=document.createElement("canvas"),g=n.getContext("2d");return n.width=s,n.height=d,g.drawImage(this.ctx.canvas,o,a,s,d,0,0,s,d),n.toDataURL("image/png")},download:function(){var t=(this.option,this.getImageDate((this.width-this.option.width)/2,(this.height-this.option.height)/2,this.option.width,this.option.height)),i=require("@file"),h=i.getBlobFromURI(t);i.saveAs(h,"photocutter.png")},upload:function(){$.loadingbar().showLoading();var t=this.option,i=this.getImageDate((this.width-this.option.width)/2,(this.height-this.option.height)/2,this.option.width,this.option.height),h=require("@file"),e=h.getBlobFromURI(i),o=this,a=new FormData;a.append(t.name,e),a.append("type","pic"),a.append("filename","pic.png"),$.ajax({url:basePath+"file/upload",data:a,method:"post",dataType:"json",headers:{},events:{load:function(t){var i=this.response.responseText;try{i=window.JSON.parse(i)}catch(t){i={}}o.dispatchEvent("uploaddone",i.data),o.remove()},progress:function(t){},error:function(t){$.toast("上传失败")}}})}});